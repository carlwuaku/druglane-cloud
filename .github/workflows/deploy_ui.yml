name: Deploy Angular App to Subdomain

on:
  push:
    branches:
      - main  # Deploy when pushing to main branch
    paths:
      - 'UI/**'  # Only trigger when UI files change
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  build-and-deploy-ui:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ==================== Frontend Setup ====================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: UI/package-lock.json

      - name: Install Angular dependencies
        working-directory: ./UI
        run: npm ci

      - name: Build Angular app for production
        working-directory: ./UI
        run: npm run build -- --configuration production

      # ==================== Prepare Deployment Package ====================
      - name: Prepare deployment files
        run: |
          echo "=æ Preparing Angular app for deployment..."

          # Check if build output exists
          if [ ! -d "UI/dist/browser" ]; then
            echo "L Build output not found!"
            exit 1
          fi

          # Create deployment directory
          mkdir -p deployment

          # Copy built Angular files
          cp -r UI/dist/browser/* deployment/

          echo " Build files prepared"
          ls -la deployment/

      # ==================== Create .htaccess for Angular ====================
      - name: Create .htaccess for Angular SPA routing
        run: |
          cat > deployment/.htaccess << 'EOF'
          <IfModule mod_rewrite.c>
            RewriteEngine On

            # Force HTTPS (optional - uncomment if you want to force SSL)
            # RewriteCond %{HTTPS} off
            # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

            # Don't rewrite files or directories
            RewriteCond %{REQUEST_FILENAME} -f [OR]
            RewriteCond %{REQUEST_FILENAME} -d
            RewriteRule ^ - [L]

            # Rewrite everything else to index.html to allow HTML5 state links
            RewriteRule ^ index.html [L]
          </IfModule>

          # Disable directory browsing
          Options -Indexes

          # Custom error pages (optional)
          ErrorDocument 404 /index.html

          # Enable compression (optional - for better performance)
          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
          </IfModule>

          # Browser caching (optional - for better performance)
          <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType text/html "access plus 0 seconds"
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/x-icon "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType font/woff "access plus 1 year"
            ExpiresByType font/woff2 "access plus 1 year"
          </IfModule>
          EOF

          echo " .htaccess created"

      # ==================== Deploy to Subdomain via FTP ====================
      - name: Deploy to Hostinger Subdomain via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.APP_FTP_SERVER }}
          username: ${{ secrets.APP_FTP_USERNAME }}
          password: ${{ secrets.APP_FTP_PASSWORD }}
          local-dir: ./deployment/
          server-dir: ./  # Deploy to root of subdomain (usually public_html/)
          dangerous-clean-slate: true  # Clean old files before uploading new ones
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

      # ==================== Deployment Summary ====================
      - name: Deployment Summary
        if: success()
        run: |
          echo "========================================="
          echo " Angular App Deployed Successfully!"
          echo "========================================="
          echo ""
          echo "=Í Deployment Target: ${{ secrets.APP_FTP_SERVER }}"
          echo "=d FTP User: ${{ secrets.APP_FTP_USERNAME }}"
          echo ""
          echo "< Your Angular app should now be live at:"
          echo "   https://your-subdomain.yourdomain.com"
          echo ""
          echo "=Ë Next Steps:"
          echo "   1. Visit your subdomain URL to verify deployment"
          echo "   2. Check that routing works (refresh on any route)"
          echo "   3. Verify API calls work correctly"
          echo "   4. Test authentication flow"
          echo ""
          echo "=' If you encounter issues:"
          echo "   - Check .htaccess is uploaded correctly"
          echo "   - Verify FTP credentials in GitHub Secrets"
          echo "   - Check browser console for errors"
          echo "   - Ensure API base URL is correct in environment"
          echo ""
          echo "========================================="

      # ==================== Deployment Failed ====================
      - name: Deployment Failed
        if: failure()
        run: |
          echo "========================================="
          echo "L Deployment Failed!"
          echo "========================================="
          echo ""
          echo "Please check the logs above for errors."
          echo ""
          echo "Common issues:"
          echo "   - FTP credentials incorrect"
          echo "   - FTP server unreachable"
          echo "   - Build failed"
          echo "   - Insufficient FTP permissions"
          echo ""
          echo "========================================="
