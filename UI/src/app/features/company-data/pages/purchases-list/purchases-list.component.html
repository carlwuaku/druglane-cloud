<app-page-container [pageTitle]="'Purchases'">
    <!-- Purchase Statistics Expandable -->
    <div class="mb-6">
        <mat-accordion>
            <mat-expansion-panel [expanded]="true">
                <mat-expansion-panel-header>
                    <mat-panel-title class="flex items-center gap-2">
                        <mat-icon>analytics</mat-icon>
                        <span class="font-semibold">Purchase Statistics</span>
                    </mat-panel-title>
                </mat-expansion-panel-header>

                @if (loading()) {
                    <div class="flex justify-center items-center py-8">
                        <p class="text-gray-500">Loading statistics...</p>
                    </div>
                } @else if (statistics()) {
                    <div class="space-y-6">
                        <!-- Period Purchases Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Period Purchases</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.today_purchases.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Today'"
                                    [description]="'Purchases for today'"
                                    [icon]="'today'"
                                    [iconBackgroundColor]="'#1976d2'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.current_week_purchases.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'This Week'"
                                    [description]="'Current week purchases'"
                                    [icon]="'date_range'"
                                    [iconBackgroundColor]="'#1976d2'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.current_month_purchases.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Current Month'"
                                    [description]="'Purchases this month'"
                                    [icon]="'calendar_month'"
                                    [iconBackgroundColor]="'#f57c00'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.ytd_purchases.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Year to Date'"
                                    [description]="'Total purchases this year'"
                                    [icon]="'event'"
                                    [iconBackgroundColor]="'#7b1fa2'">
                                </app-stats-card>
                            </div>
                        </div>

                        <!-- Performance Metrics Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Performance Metrics</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <app-stats-card
                                    [count]="(statistics()!.growth_rate >= 0 ? '+' : '') + statistics()!.growth_rate.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '%'"
                                    [title]="'Month Growth'"
                                    [description]="'vs Last Month'"
                                    [icon]="statistics()!.growth_rate >= 0 ? 'trending_up' : 'trending_down'"
                                    [iconBackgroundColor]="statistics()!.growth_rate >= 0 ? '#2e7d32' : '#d32f2f'"
                                    [tooltip]="'Calculated as: ((Current Month Purchases - Last Month Purchases) / Last Month Purchases) × 100'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="(statistics()!.week_over_week_growth >= 0 ? '+' : '') + statistics()!.week_over_week_growth.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '%'"
                                    [title]="'Week Growth'"
                                    [description]="'vs Last Week'"
                                    [icon]="statistics()!.week_over_week_growth >= 0 ? 'trending_up' : 'trending_down'"
                                    [iconBackgroundColor]="statistics()!.week_over_week_growth >= 0 ? '#2e7d32' : '#d32f2f'"
                                    [tooltip]="'Calculated as: ((Current Week Purchases - Last Week Purchases) / Last Week Purchases) × 100'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.average_purchase_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Avg Purchase Value'"
                                    [description]="'Current month average'"
                                    [icon]="'receipt'"
                                    [iconBackgroundColor]="'#1976d2'"
                                    [tooltip]="'Calculated as: Total Current Month Purchases / Number of Purchase Transactions'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="statistics()!.current_month_transactions.toLocaleString('en-US')"
                                    [title]="'Transactions'"
                                    [description]="'This month'"
                                    [icon]="'receipt_long'"
                                    [iconBackgroundColor]="'#7b1fa2'">
                                </app-stats-card>
                            </div>
                        </div>

                        <!-- Most Purchased Products Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Most Purchased Products (This Month)</h3>
                            @if (statistics()!.top_5_products && statistics()!.top_5_products.length > 0) {
                                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            @for (product of statistics()!.top_5_products; track product.name; let i = $index) {
                                                <tr class="hover:bg-gray-50 transition-colors">
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{i + 1}}</td>
                                                    <td class="px-4 py-3 text-sm text-gray-900">{{product.name}}</td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-right">{{product.total_quantity.toLocaleString('en-US')}}</td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-orange-600 text-right">GHS {{product.total_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}}</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            } @else {
                                <div class="bg-gray-50 rounded-lg p-6 text-center">
                                    <mat-icon class="text-gray-400 mb-2">inventory_2</mat-icon>
                                    <p class="text-gray-500 text-sm">No purchase data available for this month</p>
                                </div>
                            }
                        </div>

                        <!-- Top Products Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Top Purchased</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.top_product_by_value.total_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Highest by Value'"
                                    [description]="statistics()!.top_product_by_value.name"
                                    [icon]="'attach_money'"
                                    [iconBackgroundColor]="'#00897b'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="statistics()!.top_product_by_quantity.total_quantity.toLocaleString('en-US')"
                                    [title]="'Highest by Quantity'"
                                    [description]="statistics()!.top_product_by_quantity.name"
                                    [icon]="'shopping_cart'"
                                    [iconBackgroundColor]="'#d32f2f'">
                                </app-stats-card>
                            </div>
                        </div>

                        <!-- Purchase Details Link -->
                        <div class="flex justify-center pt-4">
                            <button
                                (click)="navigateToPurchaseDetails()"
                                class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors duration-200 flex items-center gap-2">
                                <mat-icon>list_alt</mat-icon>
                                <span>View Purchase Details</span>
                            </button>
                        </div>
                    </div>
                }
            </mat-expansion-panel>
        </mat-accordion>
    </div>

    <!-- Purchases List Table -->
    <app-load-data-list [url]="apiUrl" [preload]="true" [showPagination]="true" [showSearch]="true" [showExport]="true"
        [showActions]="false" [rowSelection]="undefined" [listTitleField]="'code'" [emptyMessage]="'No purchases found'"
        [limit]="100" [useResponseFilters]="true" [filterFormType]="'emit'"
        [onFilterSubmitted]="handleFilterSubmit">
    </app-load-data-list>
</app-page-container>
