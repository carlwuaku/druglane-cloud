<app-page-container [pageTitle]="'Sales'">
    <!-- Sales Statistics Expandable -->
    <div class="mb-6">
        <mat-accordion>
            <mat-expansion-panel [expanded]="true">
                <mat-expansion-panel-header>
                    <mat-panel-title class="flex items-center gap-2">
                        <mat-icon>analytics</mat-icon>
                        <span class="font-semibold">Sales Statistics</span>
                    </mat-panel-title>
                </mat-expansion-panel-header>

                @if (loading()) {
                    <div class="flex justify-center items-center py-8">
                        <p class="text-gray-500">Loading statistics...</p>
                    </div>
                } @else if (statistics()) {
                    <div class="space-y-6">
                        <!-- Filtered Period Statistics (shown when date filter is active) -->
                        @if (isFiltered()) {
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-blue-900 mb-3 uppercase tracking-wide flex items-center gap-2">
                                <mat-icon class="text-blue-600">filter_alt</mat-icon>
                                Filtered Period Statistics
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.total_sales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Total Sales'"
                                    [description]="'Sales for selected period'"
                                    [icon]="'trending_up'"
                                    [iconBackgroundColor]="'#1976d2'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.filtered_period_profit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Total Profit'"
                                    [description]="'Profit for selected period'"
                                    [icon]="'account_balance_wallet'"
                                    [iconBackgroundColor]="'#2e7d32'"
                                    [tooltip]="'Calculated as: Total Sales Revenue - Total Cost of Goods Sold for selected period'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="statistics()!.total_transactions.toLocaleString('en-US')"
                                    [title]="'Total Transactions'"
                                    [description]="'Transactions in selected period'"
                                    [icon]="'receipt_long'"
                                    [iconBackgroundColor]="'#7b1fa2'">
                                </app-stats-card>
                            </div>
                        </div>
                        }

                        <!-- Period Sales Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Period Sales</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.today_sales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Today'"
                                    [description]="'Sales for today'"
                                    [icon]="'today'"
                                    [iconBackgroundColor]="'#1976d2'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.current_week_sales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'This Week'"
                                    [description]="'Current week sales'"
                                    [icon]="'date_range'"
                                    [iconBackgroundColor]="'#1976d2'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.current_month_sales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Current Month'"
                                    [description]="'Sales this month'"
                                    [icon]="'calendar_month'"
                                    [iconBackgroundColor]="'#2e7d32'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.ytd_sales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Year to Date'"
                                    [description]="'Total sales this year'"
                                    [icon]="'event'"
                                    [iconBackgroundColor]="'#7b1fa2'">
                                </app-stats-card>
                            </div>
                        </div>

                        <!-- Performance Metrics Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Performance Metrics</h3>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                <app-stats-card
                                    [count]="(statistics()!.growth_rate >= 0 ? '+' : '') + statistics()!.growth_rate.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '%'"
                                    [title]="'Month Growth'"
                                    [description]="'vs Last Month'"
                                    [icon]="statistics()!.growth_rate >= 0 ? 'trending_up' : 'trending_down'"
                                    [iconBackgroundColor]="statistics()!.growth_rate >= 0 ? '#2e7d32' : '#d32f2f'"
                                    [tooltip]="'Calculated as: ((Current Month Sales - Last Month Sales) / Last Month Sales) × 100'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="(statistics()!.week_over_week_growth >= 0 ? '+' : '') + statistics()!.week_over_week_growth.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '%'"
                                    [title]="'Week Growth'"
                                    [description]="'vs Last Week'"
                                    [icon]="statistics()!.week_over_week_growth >= 0 ? 'trending_up' : 'trending_down'"
                                    [iconBackgroundColor]="statistics()!.week_over_week_growth >= 0 ? '#2e7d32' : '#d32f2f'"
                                    [tooltip]="'Calculated as: ((Current Week Sales - Last Week Sales) / Last Week Sales) × 100'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.average_order_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Avg Order Value'"
                                    [description]="'Current month average'"
                                    [icon]="'receipt'"
                                    [iconBackgroundColor]="'#1976d2'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="statistics()!.current_month_transactions.toLocaleString('en-US')"
                                    [title]="'Transactions'"
                                    [description]="'This month'"
                                    [icon]="'receipt_long'"
                                    [iconBackgroundColor]="'#7b1fa2'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="statistics()!.profit_margin_percentage.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '%'"
                                    [title]="'Profit Margin'"
                                    [description]="'Current month'"
                                    [icon]="'percent'"
                                    [iconBackgroundColor]="'#00897b'"
                                    [tooltip]="'Calculated as: (Current Month Profit / Current Month Sales Revenue) × 100'">
                                </app-stats-card>
                            </div>
                        </div>

                        <!-- Profitability Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Profitability</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.current_month_profit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Current Month Profit'"
                                    [description]="'Net profit this month'"
                                    [icon]="'account_balance_wallet'"
                                    [iconBackgroundColor]="'#2e7d32'"
                                    [tooltip]="'Calculated as: Total Sales Revenue - Total Cost of Goods Sold for current month'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.last_month_profit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Last Month Profit'"
                                    [description]="'Previous month profit'"
                                    [icon]="'savings'"
                                    [iconBackgroundColor]="'#f57c00'"
                                    [tooltip]="'Calculated as: Total Sales Revenue - Total Cost of Goods Sold for previous month'">
                                </app-stats-card>
                            </div>
                        </div>

                        <!-- Best Selling Products Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">
                                Best Selling Products {{ isFiltered() ? '(Filtered Period)' : '(This Month)' }}
                            </h3>
                            @if (statistics()!.top_5_products && statistics()!.top_5_products.length > 0) {
                                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            @for (product of statistics()!.top_5_products; track product.name; let i = $index) {
                                                <tr class="hover:bg-gray-50 transition-colors">
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{i + 1}}</td>
                                                    <td class="px-4 py-3 text-sm text-gray-900">{{product.name}}</td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-right">{{product.total_quantity.toLocaleString('en-US')}}</td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-green-600 text-right">GHS {{product.total_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}}</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            } @else {
                                <div class="bg-gray-50 rounded-lg p-6 text-center">
                                    <mat-icon class="text-gray-400 mb-2">inventory_2</mat-icon>
                                    <p class="text-gray-500 text-sm">No sales data available for this month</p>
                                </div>
                            }
                        </div>

                        <!-- Top Products Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Top Performers</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <app-stats-card
                                    [count]="'GHS ' + statistics()!.top_product_by_value.total_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                                    [title]="'Highest by Value'"
                                    [description]="statistics()!.top_product_by_value.name"
                                    [icon]="'attach_money'"
                                    [iconBackgroundColor]="'#00897b'">
                                </app-stats-card>

                                <app-stats-card
                                    [count]="statistics()!.top_product_by_quantity.total_quantity.toLocaleString('en-US')"
                                    [title]="'Highest by Quantity'"
                                    [description]="statistics()!.top_product_by_quantity.name"
                                    [icon]="'shopping_cart'"
                                    [iconBackgroundColor]="'#d32f2f'">
                                </app-stats-card>
                            </div>
                        </div>

                        <!-- Sales Details Link -->
                        <div class="flex justify-center pt-4">
                            <button
                                (click)="navigateToSalesDetails()"
                                class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200 flex items-center gap-2">
                                <mat-icon>list_alt</mat-icon>
                                <span>View Sales Details</span>
                            </button>
                        </div>
                    </div>
                }
            </mat-expansion-panel>
        </mat-accordion>
    </div>

    <!-- Sales List Table -->
    <app-load-data-list [url]="apiUrl" [preload]="true" [showPagination]="true" [showSearch]="true" [showExport]="true"
        [showActions]="false" [rowSelection]="undefined" [listTitleField]="'code'" [showAllFilters]="true"
        [emptyMessage]="'No sales found'" [limit]="100" [useResponseFilters]="true" [filterFormType]="'emit'"
        [onFilterSubmitted]="handleFilterSubmit">
    </app-load-data-list>
</app-page-container>